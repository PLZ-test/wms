{% extends 'core/base.html' %}

{% block extra_head %}
<style>
    .order-manage-container { display: flex; flex-direction: column; gap: 24px; padding: 20px 0; }
    .order-grid-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; width: 80%; max-width: 1200px; margin: 0 auto; }
    .top-stat-card { background-color: #fff; padding: 24px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); grid-column: 1 / -1; width: auto; }
    .top-stat-card h3 { margin: 0 0 16px 0; font-size: 1.2em; color: #333; }
    .chart-container { position: relative; height: 250px; width: 100%; }
    .status-card { background-color: #fff; padding: 24px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); border: 2px solid transparent; transition: border-color 0.2s, box-shadow 0.2s; text-align: center; display: block; text-decoration: none; color: inherit; }
    .status-card:hover { transform: translateY(-5px); box-shadow: 0 6px 12px rgba(0,0,0,0.1); }
    .status-card.success:hover { border-color: var(--accent-color); }
    .status-card.error:hover { border-color: var(--danger-color); }
    .status-card-content { height: 120px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .status-card-content .count { font-size: 1.1em; margin: 0; }
    .status-card-content .percentage { font-size: 2.5em; font-weight: bold; margin: 5px 0; }
    .status-card-content .label { margin: 0; color: #666; }
    .percentage-success { color: var(--accent-color); }
    .percentage-error { color: var(--danger-color); }
    
    .page-header .btn-group { display: flex; align-items: center; gap: 15px; }
    .date-filter-form { display: flex; align-items: center; gap: 10px; }
    .date-input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; }

    .loader-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.7); z-index: 9998; justify-content: center; align-items: center; }
    .loader { border: 8px solid #f3f3f3; border-top: 8px solid var(--accent-color); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <a href="{% url 'core:dashboard' %}" class="btn btn-secondary">뒤로가기</a>
    </div>
    <h1>주문 관리</h1>
    <div class="btn-group">
        <form method="get" action="{% url 'orders:manage' %}" class="date-filter-form">
            <input type="date" name="date" id="date-filter-input" class="date-input" value="{{ selected_date }}">
            <button type="submit" class="btn btn-info">조회</button>
        </form>
        <input type="file" id="excel-file-input" name="excel_file" accept=".xlsx, .xls" style="display: none;">
        <button id="excel-upload-btn" class="btn btn-primary">수기 등록</button>
    </div>
</div>

<div class="order-manage-container">
    <div class="order-grid-layout">
        <section class="top-stat-card">
            <h3>채널별 주문량 ({{ selected_date }})</h3>
            <div class="chart-container">
                <canvas id="channelOrderChart"></canvas>
            </div>
        </section>
        
        <a href="{% url 'orders:list_success' selected_date %}" class="status-card success">
            <h4>성공 주문 보기</h4>
            <div class="status-card-content">
                <p class="count">총 {{ daily_stats.success_count }} 건</p>
                <h2 class="percentage percentage-success">{{ daily_stats.success_rate|floatformat:1 }}%</h2>
                <p class="label">성공률</p>
            </div>
        </a>
        <a href="{% url 'orders:list_error' selected_date %}" class="status-card error">
            <h4>오류 주문 보기</h4>
            <div class="status-card-content">
                <p class="count">총 {{ daily_stats.error_count }} 건</p>
                <h2 class="percentage percentage-error">{{ daily_stats.error_rate|floatformat:1 }}%</h2>
                <p class="label">실패율</p>
            </div>
        </a>
        </div>
</div>

<div class="loader-overlay" id="loader">
    <div class="loader"></div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const uploadBtn = document.getElementById('excel-upload-btn');
    const fileInput = document.getElementById('excel-file-input');
    const loader = document.getElementById('loader');

    uploadBtn.addEventListener('click', () => {
        fileInput.value = '';
        fileInput.click();
    });

    fileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            processFile(file);
        }
    });

    function processFile(file) {
        loader.style.display = 'flex';
        const formData = new FormData();
        formData.append('excel_file', file);
        formData.append('handle_duplicates', 'no'); // 중복 제외가 기본
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        fetch("{% url 'orders:process_excel_api' %}", { method: 'POST', body: formData })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                window.location.href = data.redirect_url;
            } else {
                loader.style.display = 'none';
                alert('파일 처리 중 오류가 발생했습니다: ' + data.message);
            }
        })
        .catch(error => {
            loader.style.display = 'none';
            console.error('Error:', error);
            alert('파일 처리 중 오류가 발생했습니다.');
        });
    }

    // 채널별 주문량 그래프
    const ctx = document.getElementById('channelOrderChart');
    if (ctx) {
        fetch(`{% url 'orders:channel_chart_data' %}?date={{ selected_date }}`)
            .then(response => response.json())
            .then(chartData => {
                new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: chartData.labels,
                        datasets: [{
                            label: '주문 건수',
                            data: chartData.data,
                            backgroundColor: [ 'rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)', 'rgba(255, 206, 86, 0.7)', 'rgba(75, 192, 192, 0.7)', 'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)' ],
                            borderColor: '#fff',
                            borderWidth: 2
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
                });
            })
            .catch(error => console.error('차트 데이터를 불러오는 중 오류 발생:', error));
    }
});
</script>
{% endblock %}