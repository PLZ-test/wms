{% comment %}
wms/wms_app/templates/registration/signup.html

사용자 회원가입 페이지입니다.
아이디 중복 확인을 위한 버튼, 로딩 아이콘, 결과 메시지 영역이 추가되었습니다.
{% endcomment %}

{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원가입 - WMS</title>
    <link rel="stylesheet" href="{% static 'css/wms/style.css' %}">
</head>
<body>
    <div class="auth-container">
        <div class="auth-form">
            <h1>WMS 회원가입</h1>
            <p>가입 후 관리자의 승인이 필요합니다.</p>
            
            <form method="post" id="signup-form">
                {% csrf_token %}
                {% for field in form %}
                    <div class="form-group">
                        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                        
                        {% if field.name == 'username' %}
                            <div style="display: flex; width: 100%; gap: 10px;">
                                {{ field }}
                                <button type="button" id="check-username-btn" class="btn btn-secondary" style="flex-shrink: 0;">중복 확인</button>
                            </div>
                        {% else %}
                            {{ field }}
                        {% endif %}

                        {% if field.errors %}
                            <div class="error-list" style="color: var(--danger-color); font-size: 0.9em; padding-left: 0; text-align: left;">
                                {{ field.errors }}
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}

                <div id="username-feedback" style="font-size: 0.9em; text-align: left; height: 20px; padding-left: 5px; margin-bottom: 10px;">
                    <span id="username-loader" style="display: none;">확인 중...</span>
                    <span id="username-message"></span>
                </div>

                <button type="submit" class="btn btn-primary btn-block">가입하기</button>
            </form>
            <div class="auth-links">
                <a href="{% url 'login' %}">이미 계정이 있으신가요? 로그인</a>
            </div>
        </div>
    </div>
    
    {# --- [추가] 아이디 중복 확인을 위한 JavaScript 코드 --- #}
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // 1. 필요한 HTML 요소들을 변수에 저장합니다.
        const usernameInput = document.getElementById('id_username');
        const checkBtn = document.getElementById('check-username-btn');
        const loader = document.getElementById('username-loader');
        const message = document.getElementById('username-message');

        // 2. '중복 확인' 버튼에 클릭 이벤트 리스너를 추가합니다.
        checkBtn.addEventListener('click', () => {
            const username = usernameInput.value.trim();

            // 아이디 입력란이 비어있으면 아무것도 하지 않습니다.
            if (username === '') {
                message.textContent = '아이디를 먼저 입력해주세요.';
                message.style.color = 'orange';
                return;
            }

            // 로딩 아이콘을 보여주고, 이전 메시지는 숨깁니다.
            loader.style.display = 'inline';
            message.style.display = 'none';

            // 3. 백엔드 API에 아이디 중복 확인을 요청합니다.
            // fetch API를 사용하여 비동기적으로 서버와 통신합니다.
            fetch(`/api/check-username/?username=${username}`)
                .then(response => response.json()) // 서버 응답을 JSON 형태로 파싱합니다.
                .then(data => {
                    // 4. 응답 결과를 바탕으로 메시지를 표시합니다.
                    loader.style.display = 'none'; // 로딩 아이콘 숨기기
                    message.style.display = 'inline'; // 메시지 영역 보이기

                    if (data.is_available) {
                        // 사용 가능한 아이디일 경우
                        message.textContent = '사용 가능한 아이디입니다.';
                        message.style.color = 'green';
                    } else {
                        // 이미 사용 중인 아이디일 경우
                        message.textContent = '이미 사용 중인 아이디입니다.';
                        message.style.color = 'var(--danger-color)';
                    }
                })
                .catch(error => {
                    // 5. 통신 중 오류가 발생한 경우
                    loader.style.display = 'none';
                    message.style.display = 'inline';
                    message.textContent = '오류가 발생했습니다. 다시 시도해주세요.';
                    message.style.color = 'var(--danger-color)';
                    console.error('Error:', error);
                });
        });

        // 사용자가 아이디를 다시 수정하면, 이전 확인 메시지를 초기화합니다.
        usernameInput.addEventListener('input', () => {
            message.textContent = '';
        });
    });
    </script>
    {# ---------------------------------------------------- #}
</body>
</html>