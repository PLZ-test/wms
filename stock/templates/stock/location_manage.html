{% extends 'core/base.html' %}

{% block extra_head %}
<style>
    /* 모달 스타일 */
    .modal { display: none; position: fixed; z-index: 1002; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
    .modal-content { position: relative; background-color: #fefefe; margin: 10% auto; padding: 0; border-radius: 8px; width: 90%; max-width: 600px; box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19); animation: animatetop 0.4s; }
    @keyframes animatetop { from {top: -300px; opacity: 0} to {top: 0; opacity: 1} }
    .modal-header { padding: 16px; background-color: var(--accent-color); color: white; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center; }
    .modal-header h2 { margin: 0; font-size: 1.2em; }
    .modal-body { padding: 20px; }
    .close-btn { color: #fff; font-size: 28px; font-weight: bold; cursor: pointer; }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div><a href="{% url 'stock:in_bound' %}" class="btn btn-secondary">입고 페이지로</a></div>
    <h1>{{ page_title }}</h1>
    <div class="btn-group">
        {# [신규] '신규 위치 등록' 버튼 #}
        <button id="open-create-modal-btn" class="btn btn-primary">신규 위치 등록</button>
    </div>
</div>

{% if messages %}{% for message in messages %}<p class="message {{ message.tags }}">{{ message }}</p>{% endfor %}{% endif %}

<table class="list-table">
    <thead>
        <tr>
            <th>번호</th>
            <th>센터</th>
            <th>구역</th>
            <th>위치명</th>
            <th>최대 층수</th>
            <th>관리</th>
        </tr>
    </thead>
    <tbody>
        {% for loc in locations %}
        <tr>
            <td data-label="번호">{{ forloop.counter }}</td>
            <td data-label="센터">{{ loc.center.name }}</td>
            <td data-label="구역">{{ loc.zone }}</td>
            <td data-label="위치명">{{ loc.name }}</td>
            <td data-label="최대 층수">{{ loc.max_floor }}</td>
            <td data-label="관리">
                <div class="action-buttons">
                    {# [수정] 수정 버튼에 data 속성 추가 #}
                    <button class="btn btn-info open-update-modal-btn"
                            data-pk="{{ loc.pk }}"
                            data-zone="{{ loc.zone }}"
                            data-name="{{ loc.name }}"
                            data-max-floor="{{ loc.max_floor }}"
                            data-description="{{ loc.description }}">수정</button>
                    <form action="{% url 'stock:location_delete' loc.pk %}" method="post" onsubmit="return confirm('정말로 삭제하시겠습니까?');">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger">삭제</button>
                    </form>
                </div>
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="6" style="text-align: center;">등록된 위치가 없습니다.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{# [신규] 신규 등록용 모달 #}
<div id="create-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>신규 위치 등록</h2>
            <span class="close-btn">&times;</span>
        </div>
        <div class="modal-body">
            <div class="form-container" style="margin: 0; box-shadow: none; padding: 0;">
                <form id="create-form" method="post" action="{% url 'stock:location_manage' %}">
                    {% csrf_token %}
                    {% for field in form %}
                    <div class="form-group">
                        <label for="id_{{ field.name }}">{{ field.label }}:</label>
                        {{ field }}
                    </div>
                    {% endfor %}
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">등록하기</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{# [신규] 수정용 모달 #}
<div id="update-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>재고 위치 수정</h2>
            <span class="close-btn">&times;</span>
        </div>
        <div class="modal-body">
            <div class="form-container" style="margin: 0; box-shadow: none; padding: 0;">
                {# action URL은 JavaScript가 동적으로 채워줄 것임 #}
                <form id="update-form" method="post" action="">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="update_zone">구역명:</label>
                        <input type="text" id="update_zone" name="zone" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="update_name">위치명:</label>
                        <input type="text" id="update_name" name="name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="update_max_floor">최대 층수:</label>
                        <input type="number" id="update_max_floor" name="max_floor" class="form-control" min="1" required>
                    </div>
                    <div class="form-group">
                        <label for="update_description">설명:</label>
                        <textarea id="update_description" name="description" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">수정하기</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // 공통 모달 관련 DOM 요소
    const createModal = document.getElementById('create-modal');
    const updateModal = document.getElementById('update-modal');
    const allModals = [createModal, updateModal];

    // '신규 등록' 모달 열기
    document.getElementById('open-create-modal-btn').addEventListener('click', () => {
        createModal.style.display = 'block';
    });

    // '수정' 모달 열기
    document.querySelectorAll('.open-update-modal-btn').forEach(button => {
        button.addEventListener('click', (e) => {
            const data = e.currentTarget.dataset;
            const form = document.getElementById('update-form');
            
            // 폼의 action URL을 해당 위치의 수정 URL로 설정
            form.action = `/stock/location/${data.pk}/update/`;
            
            // 모달 폼에 기존 데이터 채우기
            document.getElementById('update_zone').value = data.zone;
            document.getElementById('update_name').value = data.name;
            document.getElementById('update_max_floor').value = data.maxFloor;
            document.getElementById('update_description').value = data.description;
            
            updateModal.style.display = 'block';
        });
    });

    // 모든 모달의 닫기(X) 버튼 이벤트
    allModals.forEach(modal => {
        if (modal) {
            modal.querySelector('.close-btn').addEventListener('click', () => {
                modal.style.display = 'none';
            });
        }
    });

    // 모달 바깥 영역 클릭 시 닫기
    window.addEventListener('click', (event) => {
        allModals.forEach(modal => {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        });
    });
});
</script>
{% endblock %}